- name: "Read vars."
  ansible.builtin.include_vars:
    file: .configure.vars/handlers_service.yml
    name: h

- name: "Debug dictionary _handlers debug={{ debug | d(false) }}"
  when: debug | d(false) | bool
  ansible.builtin.debug:
    msg: |
      h: |
        {{ h | to_nice_yaml(indent=2) | indent(2) }}

- name: "Create service handlers."
  ansible.builtin.copy:
    dest: "handlers/{{ item.key }}.yml"
    mode: "0664"
    backup: true
    content: |
      ---
      # Generated by .configure.yml
      # Handlers for {{ item.key }}
      {% for command in item.value.commands | d(h.service.default.commands) %}
      - name: {{ command | capitalize }} {{ item.key }}
        listen: {{ command }} {{ item.key }}
      {% if item.key not in h.service_condition_deny %}
      {% if command in h.service_condition_commands_allow %}
        when: fp_{{ h.service_enable_var[item.key] | d(item.key) }}_enable | bool
      {% endif %}
      {% endif %}
        vbotka.freebsd.service:
          script: {{ item.key }}
          command: {{ command }}

      {% endfor %}
      # EOF
  loop: "{{ h.service | dict2items | rejectattr('key', 'in', h.service_blacklist) }}"
  loop_control:
    label: "handlers/{{ item.key }}.yml"
